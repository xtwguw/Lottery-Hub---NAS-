<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>å…¨é‡å½©ç¥¨æ•°æ®ä¸­å¿ƒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        /* === 1. é…è‰²ç³»ç»Ÿ === */
        :root {
            --bg-body: #f4f6f9; --bg-card: #ffffff;
            --text-main: #212529; --text-sub: #6c757d; --text-label: #495057;
            --border-color: #dee2e6; --header-bg: #2c3e50; --header-text: #ffffff;
            --input-bg: #ffffff; --ball-bg: #ffffff; --ball-text: #333333; --ball-border: #dee2e6;
            --highlight-bg: #fff8e1; --highlight-border: #ffe0b2; --preview-bg: #ffffff;
            --tab-active-bg: #0d6efd; --tab-active-text: #ffffff;
            --table-head-bg: #f8f9fa;
        }
        [data-theme="dark"] {
            --bg-body: #000000; --bg-card: #1c1c1e;
            --text-main: #ffffff; --text-sub: #cfcfcf; --text-label: #e0e0e0;
            --border-color: #38383a; --header-bg: #1c1c1e; --header-text: #ffffff;
            --input-bg: #2c2c2e; --ball-bg: #2c2c2e; --ball-text: #ffffff; --ball-border: #48484a;
            --highlight-bg: #3a3a3c; --highlight-border: #5a4020; --preview-bg: #2c2c2e;
            --tab-active-bg: #0a84ff; --tab-active-text: #ffffff;
            --table-head-bg: #2c2c2e;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, sans-serif; padding-bottom: 80px; transition: background 0.3s, color 0.3s; }
        .header-bar { background: var(--header-bg); color: var(--header-text); padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header, .card-footer { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); color: var(--text-main); font-weight: bold; }
        .form-control, .form-select { background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-main); }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-main); border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .nav-pills .nav-link { color: var(--text-sub); background: var(--bg-body); margin: 0 2px; }
        .nav-pills .nav-link.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        .ball { display: inline-flex; justify-content: center; align-items: center; width: 34px; height: 34px; border-radius: 50%; margin: 3px; font-weight: bold; font-size: 14px; cursor: pointer; border: 1px solid var(--ball-border); background: var(--ball-bg); color: var(--ball-text); transition: transform 0.1s; }
        .ball:active { transform: scale(0.9); }
        .ball.active-red { background-color: #e74c3c; color: white; border-color: #c0392b; }
        .ball.active-blue { background-color: #3498db; color: white; border-color: #2980b9; }
        .static-ball { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; margin: 1px; font-size: 12px; color: white; }
        .sb-red { background: #e74c3c; } .sb-blue { background: #3498db; }
        .picker-area { background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .picker-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .picker-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); margin-right: 10px; }
        #draw-info-display { font-size: 0.9rem; color: var(--text-sub); display: flex; align-items: center; }
        .picker-section-title { font-size: 13px; color: var(--text-sub); margin-bottom: 5px; font-weight: bold; }
        .current-pick-display { font-family: monospace; color: #d63384; font-weight: bold; font-size: 1.1em; }
        .qxc-row { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 5px 0; }
        .qxc-label { width: 50px; font-size: 13px; color: var(--text-label); font-weight: bold; }
        .qxc-balls { flex: 1; display: flex; flex-wrap: wrap; gap: 2px; }
        #ocr-preview-container { border: 2px dashed var(--border-color); border-radius: 8px; padding: 10px; background: var(--preview-bg); height: 100%; min-height: 220px; display: flex; align-items: center; justify-content: center; position: relative; flex-direction: column; }
        #ocr-preview-img { max-width: 100%; max-height: 350px; border-radius: 4px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        #clear-img-btn { position: absolute; top: 10px; right: 10px; z-index: 20; background: rgba(255,255,255,0.8); }
        .placeholder-text { color: var(--text-sub); font-size: 0.9rem; text-align: center; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .theme-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0d6efd; }
        input:checked + .slider:before { transform: translateX(18px); }
        .history-box { height: 400px; overflow-y: auto; }
        .ocr-btn-group { position: absolute; right: 10px; top: 10px; z-index: 10; display: flex; gap: 8px; }
        .ocr-btn { opacity: 0.9; width: 36px; height: 36px; padding: 0; line-height: 34px; }
        [data-theme="dark"] .text-secondary { color: #b0b0b0 !important; }
        .result-draw-balls { margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(0,0,0,0.1); }
        [data-theme="dark"] .result-draw-balls { border-top-color: rgba(255,255,255,0.1); }
        .result-draw-balls .static-ball { width: 22px; height: 22px; line-height: 22px; font-size: 11px; }
        .mini-ball { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; margin: 0 1px; font-size: 11px; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="header-bar">
    <div style="width: 70px;"></div>
    <div class="text-center">
        <h5 class="m-0 fw-bold">å…¨é‡å½©ç¥¨æ•°æ®ä¸­å¿ƒ</h5>
        <div id="clock" class="small mt-1 opacity-75" style="font-size: 0.75rem;">Loading...</div>
    </div>
    <div class="theme-switch-wrapper">
        <span id="theme-icon" style="font-size:1.2rem;">ğŸŒ</span>
        <label class="theme-switch">
            <input type="checkbox" id="checkbox" onchange="toggleTheme(this.checked)">
            <div class="slider"></div>
        </label>
    </div>
</div>

<div class="container">
    <ul class="nav nav-pills nav-fill mb-4 p-1 shadow-sm rounded" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
        <li class="nav-item"><button id="tab-ssq" class="nav-link active" onclick="loadTab('ssq')">åŒè‰²çƒ</button></li>
        <li class="nav-item"><button id="tab-dlt" class="nav-link" onclick="loadTab('dlt')">å¤§ä¹é€</button></li>
        <li class="nav-item"><button id="tab-7xc" class="nav-link" onclick="loadTab('7xc')">ä¸ƒæ˜Ÿå½©</button></li>
    </ul>

    <div class="row g-3 mb-4">
        <div class="col-6"><div class="card h-100"><div class="card-body text-center py-2"><div class="small fw-bold text-secondary">ğŸ›‘ æˆªæ­¢æ—¶é—´</div><div id="cd-stop" class="badge bg-secondary mt-1">--</div></div></div></div>
        <div class="col-6"><div class="card h-100"><div class="card-body text-center py-2"><div class="small fw-bold text-secondary">ğŸ‰ å¼€å¥–æ—¶é—´</div><div id="cd-draw" class="badge bg-danger mt-1">--</div></div></div></div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center pt-3">
            <span><i class="bi bi-clock-history"></i> å†å²å¼€å¥–</span>
            <div class="d-flex gap-1">
                <select id="filter-year" class="form-select form-select-sm" style="width:auto; min-width:80px;" onchange="resetAndLoadHistory(this.value)"></select>
                <select id="filter-history-issue" class="form-select form-select-sm" style="width:auto; min-width:90px;" onchange="filterHistoryByIssue(this.value)">
                    <option value="all">æ‰€æœ‰æœŸæ•°</option>
                </select>
            </div>
        </div>
        <div class="history-box p-0" id="history-box">
            <div id="history-list" class="accordion accordion-flush"></div>
            <div id="history-loading" class="text-center p-3 small text-muted" style="display:none">åŠ è½½æ›´å¤š...</div>
        </div>
    </div>

    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center pt-3">
            <span><i class="bi bi-calculator"></i> é€‰å·æŸ¥è¯¢</span>
            <div id="dlt-opt" style="display:none;" class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" id="zj-chk"><label class="form-check-label small">è¿½åŠ </label></div>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-lg-7 col-12">
                    <div class="mb-3"><select class="form-select" id="issue-sel" onchange="updateDrawDisplay()"><option value="latest">æ ¸å¯¹æœ€æ–°ä¸€æœŸ</option></select></div>
                    
                    <div class="picker-area">
                        <div class="picker-header-row">
                            <div id="picker-title-container"></div>
                            <div id="draw-info-display"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom" style="border-color:var(--border-color)!important;">
                            <span class="small text-secondary">æš‚å­˜: <span id="current-pick-text" class="current-pick-display ms-2"></span></span>
                            <button class="btn btn-sm btn-success rounded-pill px-3" onclick="addCurrentPickToList()"><i class="bi bi-plus-lg"></i> ä¸‹ä¸€ç»„</button>
                        </div>
                        <div id="number-picker"></div>
                    </div>

                    <div class="position-relative mb-3">
                        <textarea class="form-control shadow-none" id="bet-nums" rows="6" placeholder="å·ç åˆ—è¡¨ (æ¯è¡Œä¸€ç»„)" oninput="syncPickerFromText()"></textarea>
                        <div class="ocr-btn-group">
                            <input type="file" id="file-input" accept="image/*" hidden onchange="initCrop(this)">
                            <button class="btn btn-light border ocr-btn shadow-sm text-primary" onclick="document.getElementById('file-input').click()"><i class="bi bi-image"></i></button>
                            <input type="file" id="camera-input" accept="image/*" capture="environment" hidden onchange="initCrop(this)">
                            <button class="btn btn-light border ocr-btn shadow-sm" onclick="document.getElementById('camera-input').click()"><i class="bi bi-camera-fill"></i></button>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary flex-fill" onclick="clearAll()">æ¸…ç©º</button>
                        <button class="btn btn-primary flex-fill" onclick="doCheck('current')">æŸ¥è¯¢é€‰ä¸­æœŸ</button>
                        <button class="btn btn-outline-danger flex-fill" onclick="doCheck('history')">æ‰«å†å²</button>
                    </div>
                </div>
                
                <div class="col-lg-5 col-12">
                    <div id="ocr-preview-container">
                        <button type="button" class="btn-close" id="clear-img-btn" aria-label="Close" onclick="clearImagePreview()" title="ç§»é™¤å›¾ç‰‡"></button>
                        <div id="ocr-placeholder" class="placeholder-text">
                            <i class="bi bi-image" style="font-size: 3rem; opacity: 0.3;"></i><br>
                            è¯†åˆ«åŸå›¾å°†æ˜¾ç¤ºåœ¨æ­¤å¤„<br>æ–¹ä¾¿å¯¹æ¯”ä¿®æ”¹
                        </div>
                        <img id="ocr-preview-img" src="" alt="OCR Preview">
                    </div>
                </div>
            </div>
        </div>
        <div id="check-results" class="card-footer border-top-0"></div>
    </div>
</div>

<div class="modal fade" id="cropModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow" style="background-color: var(--bg-card); color: var(--text-main);">
            <div class="modal-header border-bottom py-2" style="border-color:var(--border-color)!important;"><h6 class="m-0 fw-bold">å›¾ç‰‡å¤„ç†</h6><button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--text-main) == '#ffffff' ? invert(1) : none;"></button></div>
            <div class="modal-body bg-black"><div style="height:60vh;background:#000;border-radius:8px;overflow:hidden"><img id="image-to-crop" src="" style="max-width:100%"></div><div class="mt-3 d-flex align-items-center gap-3"><i class="bi bi-arrow-counterclockwise fs-4 text-white" onclick="rotateImage(-90)"></i><input type="range" class="form-range flex-grow-1" min="-45" max="45" value="0" oninput="rotateImage(this.value, true)"><i class="bi bi-arrow-clockwise fs-4 text-white" onclick="rotateImage(90)"></i></div></div>
            <div class="modal-footer border-top py-2" style="border-color:var(--border-color)!important;"><button id="crop-confirm-btn" class="btn btn-primary w-100" onclick="performCropAndUpload()">å¼€å§‹è¯†åˆ«</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    let currentType = 'ssq', globalData = null, timerInt;
    let selectedBalls = { red: [], blue: [], qxc: [[],[],[],[],[],[],[]] }; 
    let cropper = null, cropModal = null;
    let historyState = { offset: 0, limit: 20, year: 'all', issue: 'all', isLoading: false, hasMore: true };
    let allIssuesMap = {};

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString('zh-CN'); }, 1000);
    
    function initTheme() {
        const hour = new Date().getHours();
        const isNight = hour >= 18 || hour < 6;
        const saved = localStorage.getItem('theme');
        const isDark = saved === 'dark' || (!saved && isNight);
        updateThemeUI(isDark);
    }
    function toggleTheme(isChecked) { updateThemeUI(isChecked); localStorage.setItem('theme', isChecked ? 'dark' : 'light'); }
    function updateThemeUI(isDark) {
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('checkbox').checked = isDark;
        document.getElementById('theme-icon').innerText = isDark ? "ğŸŒ™" : "ğŸŒ";
        const closeBtns = document.querySelectorAll('.btn-close');
        closeBtns.forEach(btn => btn.style.filter = isDark ? 'invert(1)' : 'none');
    }

    window.onload = function() {
        initTheme();
        if(document.getElementById('cropModal')) cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
        fetch('/api/init').then(r=>r.json()).then(d=>{ 
            globalData=d; loadTab('ssq'); 
            document.getElementById('history-box').addEventListener('scroll', (e) => {
                if(e.target.scrollTop + e.target.clientHeight >= e.target.scrollHeight - 50) loadMoreHistory();
            });
        }).catch(e=>console.error(e));
    };

    function loadTab(type) {
        currentType = type;
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + type).classList.add('active');
        clearAll(); renderPicker(type);
        if (!globalData || !globalData[type]) return;
        const d = globalData[type];
        startDualTimer(d.next_stop, d.next_draw);
        
        const ySel = document.getElementById('filter-year');
        ySel.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>' + d.years.map(y=>`<option value="${y}">${y}å¹´</option>`).join('');
        ySel.value = 'all';
        
        allIssuesMap = {};
        const sel = document.getElementById('issue-sel');
        let issueOpts = `<option value="latest">æ ¸å¯¹æœ€æ–°ä¸€æœŸ</option>`;
        d.all_issues.forEach(i => { allIssuesMap[i.issue] = i; issueOpts += `<option value="${i.issue}">ç¬¬ ${i.issue} æœŸ</option>`; });
        sel.innerHTML = issueOpts;
        if (d.all_issues.length > 0) allIssuesMap['latest'] = d.all_issues[0];
        
        updateDrawDisplay();

        document.getElementById('dlt-opt').style.display = (type === 'dlt') ? 'block' : 'none';
        resetAndLoadHistory('all');
    }

    function updateDrawDisplay() {
        const val = document.getElementById('issue-sel').value;
        const display = document.getElementById('draw-info-display');
        const data = allIssuesMap[val];
        
        if (!data || !data.red) { display.innerHTML = '<span class="badge bg-secondary">å¾…å¼€å¥–</span>'; return; }
        
        const rArr = data.red.split(' '); 
        const bArr = data.blue ? data.blue.split(' ') : [];
        const balls = rArr.map(n=>`<span class="mini-ball sb-red">${n}</span>`).join('') + 
                      bArr.map(n=>`<span class="mini-ball sb-blue">${n}</span>`).join('');
        
        const infoHtml = `<span class="me-2 small text-secondary">ç¬¬ ${data.issue} æœŸ (${data.date})</span>`;
        const labelHtml = `<span class="me-2 small fw-bold">å¼€å¥–å·ç :</span>`;
        
        display.innerHTML = `${infoHtml}${labelHtml}${balls}`;
    }

    function renderPicker(type) {
        const container = document.getElementById('number-picker'); container.innerHTML = ''; document.getElementById('current-pick-text').innerText = ''; selectedBalls = { red: [], blue: [], qxc: [[],[],[],[],[],[],[]] };
        let titleText = "";
        if (type === 'ssq') titleText = "åŒè‰²çƒé€‰å·"; else if (type === 'dlt') titleText = "å¤§ä¹é€é€‰å·"; else if (type === '7xc') titleText = "ä¸ƒæ˜Ÿå½©é€‰å·";
        document.getElementById('picker-title-container').innerHTML = `<div class="picker-title">${titleText}</div>`;
        if (type === '7xc') {
            const posNames = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ(æœ«)'];
            let html = '';
            for(let i=0; i<7; i++) {
                const maxNum = (i === 6) ? 14 : 9;
                let ballsHtml = ''; for(let n=0; n<=maxNum; n++) ballsHtml += `<div class="ball" onclick="toggleBall('qxc', ${i}, '${n}', this)">${n}</div>`;
                const rowStyle = i===6 ? 'background:var(--highlight-bg); border-radius:4px;' : '';
                html += `<div class="qxc-row" style="${rowStyle}"><div class="qxc-label">${posNames[i]}</div><div class="qxc-balls">${ballsHtml}</div></div>`;
            }
            container.innerHTML = html;
        } else {
            const redCount = type === 'ssq' ? 33 : 35; const blueCount = type === 'ssq' ? 16 : 12;
            const redLabel = type === 'dlt' ? 'å‰åŒº (çº¢çƒ)' : 'çº¢çƒåŒº'; const blueLabel = type === 'dlt' ? 'ååŒº (è“çƒ)' : 'è“çƒåŒº';
            let html = `<div class="picker-section-title text-danger">${redLabel}</div><div class="ball-container mb-3">`;
            for(let i=1; i<=redCount; i++) html += `<div class="ball" onclick="toggleBall('red', 0, '${i.toString().padStart(2,'0')}', this)">${i.toString().padStart(2,'0')}</div>`;
            html += `</div><div class="picker-section-title text-primary">${blueLabel}</div><div class="ball-container">`;
            for(let i=1; i<=blueCount; i++) html += `<div class="ball" onclick="toggleBall('blue', 0, '${i.toString().padStart(2,'0')}', this)">${i.toString().padStart(2,'0')}</div>`;
            html += `</div>`;
            container.innerHTML = html;
        }
    }

    function toggleBall(ct, ri, n, el) {
        let ac = (ct === 'red' || (ct === 'qxc' && ri < 6)) ? 'active-red' : 'active-blue'; if (currentType === '7xc' && ri === 6) ac = 'active-blue';
        if (currentType === '7xc') {
            const idx = selectedBalls.qxc[ri].indexOf(n);
            if (idx > -1) { selectedBalls.qxc[ri].splice(idx, 1); el.classList.remove(ac); }
            else { selectedBalls.qxc[ri].push(n); selectedBalls.qxc[ri].sort((a,b)=>Number(a)-Number(b)); el.classList.add(ac); }
        } else {
            const list = selectedBalls[ct]; const idx = list.indexOf(n);
            if (idx > -1) { list.splice(idx, 1); el.classList.remove(ac); }
            else { list.push(n); list.sort(); el.classList.add(ac); }
        }
        updatePreviewText();
    }
    function updatePreviewText(){
        let t=''; if(currentType==='7xc'){ let p=[]; for(let i=0;i<7;i++) p.push(selectedBalls.qxc[i].length?selectedBalls.qxc[i].join(','):'?'); t=p.join(' '); }
        else { t=`${selectedBalls.red.join(' ')}${selectedBalls.blue.length?' + '+selectedBalls.blue.join(' '):''}`; }
        document.getElementById('current-pick-text').innerText=t;
    }
    function addCurrentPickToList(){
        const p=document.getElementById('current-pick-text').innerText.trim(); if(!p||p.includes('?')) return alert("å·ç ä¸å®Œæ•´");
        const ta=document.getElementById('bet-nums'); ta.value=ta.value.trim()?(ta.value.trim()+'\n'+p):p; ta.scrollTop=ta.scrollHeight;
        document.querySelectorAll('.ball').forEach(b=>b.classList.remove('active-red','active-blue')); selectedBalls={red:[],blue:[],qxc:[[],[],[],[],[],[],[]]}; document.getElementById('current-pick-text').innerText='';
    }
    
    function clearImagePreview() {
        document.getElementById('ocr-preview-img').src = ''; document.getElementById('ocr-preview-img').style.display = 'none';
        document.getElementById('clear-img-btn').style.display = 'none'; document.getElementById('ocr-placeholder').style.display = 'block';
        document.getElementById('file-input').value = ''; document.getElementById('camera-input').value = '';
    }
    function clearAll() { document.getElementById('bet-nums').value = ''; document.getElementById('check-results').innerHTML = ''; clearImagePreview(); document.querySelectorAll('.ball').forEach(b => b.classList.remove('active-red', 'active-blue')); selectedBalls = { red: [], blue: [], qxc: [[],[],[],[],[],[],[]] }; document.getElementById('current-pick-text').innerText = ''; }

    function resetAndLoadHistory(year) { 
        historyState = { offset: 0, limit: 20, year: year, issue: 'all', isLoading: false, hasMore: true }; 
        document.getElementById('history-list').innerHTML = ''; 
        const issueSel = document.getElementById('filter-history-issue');
        const all = globalData[currentType].all_issues;
        let filtered = all;
        if (year !== 'all') filtered = all.filter(i => i.date.startsWith(year));
        issueSel.innerHTML = '<option value="all">æ‰€æœ‰æœŸæ•°</option>' + filtered.map(i => `<option value="${i.issue}">${i.issue}æœŸ</option>`).join('');
        issueSel.value = 'all';
        loadMoreHistory(); 
    }
    function filterHistoryByIssue(issue) {
        historyState = { offset: 0, limit: 1, year: 'all', issue: issue, isLoading: false, hasMore: false };
        document.getElementById('history-list').innerHTML = '';
        loadMoreHistory();
    }
    async function loadMoreHistory() {
        if (historyState.isLoading || (!historyState.hasMore && historyState.issue === 'all')) return;
        historyState.isLoading = true; document.getElementById('history-loading').style.display = 'block';
        try {
            const resp = await fetch('/api/history_list', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: currentType, year: historyState.year, issue: historyState.issue, offset: historyState.offset, limit: historyState.limit }) });
            const data = await resp.json();
            if (data.success && data.data.length > 0) {
                renderHistoryAppend(data.data); historyState.offset += data.data.length;
                if (data.data.length < historyState.limit) historyState.hasMore = false;
            } else historyState.hasMore = false;
        } catch(e) { console.error(e); } finally { historyState.isLoading = false; document.getElementById('history-loading').style.display = 'none'; }
    }
    
    function renderHistoryAppend(list) {
        const h = list.map(row => {
            const rArr = row.red.split(' '); const bArr = row.blue ? row.blue.split(' ') : [];
            const ballHtml = rArr.map(n => `<span class="static-ball sb-red">${n}</span>`).join('') + bArr.map(n => `<span class="static-ball sb-blue">${n}</span>`).join('');
            let prizes = ''; 
            try{ 
                const p=JSON.parse(row.prizes); 
                if(p.length) prizes=`<div class="mt-2"><table class="table table-sm table-bordered text-center small mb-0" style="color:var(--text-main); border-color:var(--border-color);"><thead style="background-color:var(--table-head-bg);"><tr><th>å¥–é¡¹</th><th>æ³¨æ•°</th><th>å¥–é‡‘</th></tr></thead><tbody>`+p.map(x=>`<tr><td>${x.n}</td><td>${x.c}</td><td class="text-danger fw-bold">${x.m}</td></tr>`).join('')+`</tbody></table></div>`; 
            }catch(e){}
            return `<div class="accordion-item" style="background:transparent;"><h2 class="accordion-header"><button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#h-${row.issue}" style="background:var(--bg-card); color:var(--text-main);"><div class="w-100"><div class="d-flex justify-content-between small mb-1" style="color:var(--text-sub);"><span>ç¬¬ ${row.issue} æœŸ</span><span>${row.date}</span></div><div>${ballHtml}</div></div></button></h2><div id="h-${row.issue}" class="accordion-collapse collapse" data-bs-parent="#history-list"><div class="accordion-body p-2" style="background:var(--bg-body); color:var(--text-main);">${prizes}</div></div></div>`;
        }).join('');
        document.getElementById('history-list').insertAdjacentHTML('beforeend', h);
    }

    function initCrop(el) { const f=el.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ document.getElementById('image-to-crop').src=e.target.result; cropModal.show(); document.getElementById('crop-confirm-btn').disabled=false; document.getElementById('crop-confirm-btn').innerText="å¼€å§‹è¯†åˆ«"; setTimeout(()=>{if(cropper)cropper.destroy();cropper=new Cropper(document.getElementById('image-to-crop'),{viewMode:1,dragMode:'move',autoCropArea:0.9})},200); }; r.readAsDataURL(f); }
    function rotateImage(v,abs){ if(cropper) abs?cropper.rotateTo(parseInt(v)):cropper.rotate(parseInt(v)); }
    function performCropAndUpload() { if(!cropper)return; const btn=document.getElementById('crop-confirm-btn'); btn.disabled=true; btn.innerText="å¤„ç†ä¸­..."; cropper.getCroppedCanvas({maxWidth:2048,maxHeight:2048,fillColor:'#fff'}).toBlob((blob)=>{const url=URL.createObjectURL(blob);document.getElementById('ocr-preview-img').src=url;document.getElementById('ocr-preview-img').style.display='block';document.getElementById('ocr-placeholder').style.display='none';document.getElementById('clear-img-btn').style.display='block';cropModal.hide();uploadBlob(blob)},'image/jpeg',0.85); }
    async function uploadBlob(blob){ const fd=new FormData(); fd.append('file',blob,'ocr.jpg'); fd.append('type',currentType); try{ const r=await fetch('/api/ocr',{method:'POST',body:fd}); const d=await r.json(); if(d.success){const ta=document.getElementById('bet-nums');ta.value=ta.value.trim()?(ta.value.trim()+'\n'+d.lines.join('\n')):d.lines.join('\n');document.querySelectorAll('.ball').forEach(b=>b.classList.remove('active-red','active-blue'));}else alert(d.message); }catch(e){alert(e.message);} }
    function startDualTimer(st,dt){ clearInterval(timerInt); const cf=(t)=>{const d=new Date(t)-new Date();if(d<0)return "å·²ç»“æŸ";return `${Math.floor(d/86400000)}å¤© ${Math.floor((d%86400000)/3600000)}æ—¶ ${Math.floor((d%3600000)/60000)}åˆ† ${Math.floor((d%60000)/1000)}ç§’`}; timerInt=setInterval(()=>{document.getElementById('cd-stop').innerText=cf(new Date(st));document.getElementById('cd-draw').innerText=cf(new Date(dt))},1000); }
    function syncPickerFromText(){document.querySelectorAll('.ball').forEach(b=>b.classList.remove('active-red','active-blue')); selectedBalls={red:[],blue:[],qxc:[[],[],[],[],[],[],[]]};}

    async function doCheck(mode) {
        const raw = document.getElementById('bet-nums').value.trim(); if (!raw) return alert("è¯·è¾“å…¥å·ç ");
        const resDiv = document.getElementById('check-results'); resDiv.innerHTML = '<div class="p-3 text-center text-secondary"><div class="spinner-border spinner-border-sm"></div> è®¡ç®—ä¸­...</div>';
        const bets = raw.split('\n').map(s=>({nums:s})).filter(x=>x.nums);
        try {
            const resp = await fetch('/api/check', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ type:currentType, mode:mode, issue:document.getElementById('issue-sel').value, zhuijia:document.getElementById('zj-chk').checked, bets:bets }) });
            const data = await resp.json();
            if(!Array.isArray(data)) throw new Error(data.message||"Error");
            if(data.length===0) { resDiv.innerHTML='<div class="p-3 text-center text-muted">æœªä¸­å¥–</div>'; return; }
            let html = '';
            data.forEach(item => {
                let matchesHtml = '';
                if(item.matches.length === 0) matchesHtml = `<div class="text-secondary small">æœªä¸­å¥–</div>`;
                else {
                    item.matches.forEach(m => {
                        const drawR = m.draw_red.split(' ').map(n=>`<span class="static-ball sb-red">${n}</span>`).join('');
                        const drawB = m.draw_blue ? m.draw_blue.split(' ').map(n=>`<span class="static-ball sb-blue">${n}</span>`).join('') : '';
                        const drawBalls = `<div class="result-draw-balls d-flex align-items-center mb-1"><span class="small me-2" style="color:var(--text-sub)">å¼€å¥–:</span>${drawR}${drawB}</div>`;
                        
                        let titleHtml = '';
                        if (m.win_data.is_win) {
                            titleHtml = `<span class="text-danger fw-bold">Â¥${m.win_data.total_money.toLocaleString()}</span> <span class="badge bg-warning text-dark">${m.win_data.total_money_cn||''}</span>`;
                        } else {
                            titleHtml = `<span class="badge bg-secondary">æœªä¸­å¥–</span>`;
                        }
                        let balls = `<div class="mb-1 small">ç¬¬${m.issue}æœŸ <span class="text-secondary">(${m.date})</span>: ${titleHtml}</div>`;
                        
                        let details = ''; 
                        if(m.win_data.is_win) {
                            for(let k in m.win_data.details) details += `<span class="badge bg-danger me-1">${k} x${m.win_data.details[k].count}</span>`;
                        }

                        let userBalls = '';
                        let rp=[], bp=[]; 
                        const betStr = item.bet.replace(/[,ï¼Œ]/g, ' ').trim();
                        if (currentType === '7xc') { rp = betStr.split(/\s+/); } 
                        else {
                            if (item.bet.includes('+')) { const parts = item.bet.split('+'); rp = parts[0].replace(/[,ï¼Œ]/g, ' ').trim().split(/\s+/); bp = parts[1].replace(/[,ï¼Œ]/g, ' ').trim().split(/\s+/); } 
                            else { const all = betStr.split(/\s+/); if(currentType==='ssq'){ rp = all.slice(0, all.length-1); bp = all.slice(all.length-1); } else { rp = all.slice(0, all.length-2); bp = all.slice(all.length-2); } }
                        }
                        userBalls = '<div class="mb-2">';
                        rp.forEach(n => { userBalls += `<span class="ball ${m.win_data.hit_red.includes(n) ? 'active-red' : ''}">${n}</span>`; });
                        if (bp.length > 0) { userBalls += ' <span class="text-muted small">+</span> '; bp.forEach(n => { userBalls += `<span class="ball ${m.win_data.hit_blue.includes(n) ? 'active-blue' : ''}">${n}</span>`; }); }
                        userBalls += '</div>';

                        matchesHtml += `<div class="p-2 rounded mb-2 border" style="background-color:var(--highlight-bg); border-color:var(--highlight-border);">${balls}${drawBalls}<hr class="my-2" style="border-style:dashed; opacity:0.3;">${userBalls}${details}</div>`;
                    });
                }
                html += `<div class="p-3 border-bottom" style="border-color:var(--border-color)!important">${matchesHtml}</div>`;
            });
            resDiv.innerHTML = html;
        } catch(e) { resDiv.innerHTML = `<div class="p-3 text-danger">${e.message}</div>`; }
    }
</script>
</body>
</html>
